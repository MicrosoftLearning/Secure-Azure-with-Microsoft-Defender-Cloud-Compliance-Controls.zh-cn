---
lab:
  title: 练习 02 - 创建虚拟网络基础结构
  module: Module 03 - Filter network traffic with a network security group using the Azure portal
---


>**注意**：为了完成此实验室，你将需要一个 [Azure 订阅](https://azure.microsoft.com/en-us/free/?azure-portal=true)。 其中您拥有管理权限。 


可以使用网络安全组来筛选进出 Azure 虚拟网络中 Azure 资源的入站和出站网络流量。 网络安全组包含安全规则，这些规则可按 IP 地址、端口和协议筛选网络流量。 当网络安全组与某个子网关联时，安全规则将应用于该子网中部署的资源。

## 体系结构关系图

![image](https://github.com/MicrosoftLearning/Secure-Azure-services-and-workloads-with-Microsoft-Cloud-Security-Benchmark/assets/91347931/1bfec315-129b-48a9-9c35-1f21c837068f)

---

## 技能任务

- 创建网络安全组和安全规则。
  
- 创建应用程序安全组。
  
- 创建虚拟网络并将网络安全组关联到子网。
  
- 部署虚拟机并将其网络接口关联到应用程序安全组。
  
- 测试流量筛选器。

## 练习说明 

### 创建 azure 资源组和虚拟网络。

>**注意**：以下任务创建了一个带有资源子网的虚拟网络。

1. 启动浏览器会话并登录到 [Azure 门户](https://portal.azure.com/)。             
   
2. 在门户顶部的搜索框中输入**虚拟网络**。 在搜索结果中，选择**虚拟网络**。

3. 在虚拟网络页面上，选择+ **创建**。

4. 在**创建虚拟网络**的**基本信息**选项卡上输入或选择以下信息：
   
   |设置|值|
   |---|---|
   |**项目详细信息**|
   |订阅|选择订阅|
   |资源组|选择**新建** 输入 **az-rg-1** 选择**确定**|
   |**实例详细信息**|
   |虚拟网络名称|输入**vnet-1**|
   |区域|选择 **(US)美国东部**|  
    
5. 选择**下一步**，转到**安全性**选项卡。
  
6. 选择**下一步**，转到**IP 地址**选项卡。

7. 在“子网”下的地址空间框中，选择“默认”子网********。

8. 在“**编辑子网**”模板中，输入或选择以下信息：

   |设置|值|
   |---|---|
   |**子网详细信息**|
   |子网模板|保留默认值**默认**|
   |名称|输入**subnet-1**|
   |开始地址|保留默认值**10.0.0.0**|
   |子网大小|保留默认值 **/24 (256 个地址)**。

![image](https://github.com/MicrosoftLearning/Secure-Azure-services-and-workloads-with-Microsoft-Defender-for-Cloud-regulatory-compliance-controls/assets/91347931/73c40ee1-1452-4b7d-8328-004c795a7b1e)

9. 选择**保存**。

10. 选择屏幕底部的**查看 + 创建**，然后在验证通过时选择**创建**。

### 创建应用程序安全组，以便将具有类似功能的服务器（如网络服务器）分组。

使用应用程序安全组 (ASG) 可将功能类似的服务器（例如 Web 服务器）分组到一起。

1. 在门户顶部的搜索框中，输入**应用程序安全组**。 在搜索结果中选择**应用程序安全组**。
   
2. 选择**创建**。

3. 在**创建应用程序安全组**的**基本信息**选项卡中，输入或选择以下信息：
   
   |设置|值|
   |---|---|
   |**项目详细信息**|
   |订阅|选择订阅|
   |资源组|选择 **az-rg-1**|
   |**实例详细信息**|
   |名称|输入**asg-web**|
   |区域|选择**美国东部**|  
    
4. 选择**查看 + 创建**。

5. 选择**创建**。

6. 重复上述步骤并指定以下值：
    
   |设置|值|
   |---|---|
   |**项目详细信息**|
   |订阅|选择订阅|
   |资源组|选择 **az-rg-1**|
   |**实例详细信息**|
   |名称|输入**asg-mgmt**|
   |区域|选择**美国东部**|

7. 选择**查看 + 创建**。

8. 选择**创建**。

### 创建网络安全网关，确保虚拟网络中网络流量的安全。

网络安全组 (NSG) 保护虚拟网络中的网络流量。

1. 在门户顶部的搜索框中，输入**网络安全组**。 在搜索结果中选择**网络安全组**。

>**注意**：在网络安全组的搜索结果中，你可能会看到网络安全组（经典）。 选择网络安全组。
   
2. 选择 **+ 新建**。

3. 在**创建网络安全组**的**基本信息**选项卡中，输入或选择以下信息：
   
   |设置|值|
   |---|---|
   |**项目详细信息**|
   |订阅|选择订阅|
   |资源组|选择 **az-rg-1**|
   |**实例详细信息**|
   |名称|输入**nsg-1**|
   |区域|选择**美国东部**|  
    
4. 选择“查看 + 创建”。

5. 选择“创建”。

### 将网络安全组关联到子网

>**注意**：在本任务，你要将网络安全组与前面创建的虚拟网络的子网相关联。

1. 在门户顶部的搜索框中，输入**网络安全组**。 在搜索结果中选择**网络安全组**。
   
2. 选择**nsg-1**。

3. 在**nsg-1**的**设置**部分选择**子网**。

4. 在**nsg-1 | 子网**页中，选择 + **关联：**。

 ![image](https://github.com/MicrosoftLearning/Secure-Azure-services-and-workloads-with-Microsoft-Defender-for-Cloud-regulatory-compliance-controls/assets/91347931/3b2004f6-963f-43df-9d05-3999d2e97d76)

5. 在**关联子网**下，为**虚拟网络**选择 **vnet-1** (az-rg-1)。

6. 为**子网**选择**subnet-1**，然后选择**确定**。

### 使用之前创建的虚拟网络子网为网络安全组创建安全规则。

1. 在**nsg-1**的**设置**部分选择**入站安全规则**。
   
2. 在 **nsg-1 | 入站安全规则** 页中，选择 + ** 添加：**

3. 创建一项允许端口 80 和 443 与 **asg-web** 应用程序安全组通信的安全规则。 在**添加入站安全规则**页中，输入或选择以下信息：

   |设置|值|
   |---|---|
   |Source|保留默认值**任意**|
   |源端口范围|保留默认值(*)****|
   |目标|选择**应用程序安全组**|
   |目标应用程序安全组|选择**asg-web**|
   |服务|保留默认值**自定义**|
   |目标端口范围|输入80,443****|
   |协议|选择**TCP**。|
   |操作|保留默认值**允许**|
   |优先级|保留默认值**100**|
   |名称|输入 **allowweball**|

4. 选择 **添加** 。

5. 根据以下信息完成前面的步骤：

   |设置|值|
   |---|---|
   |Source|保留默认值**任意**|
   |源端口范围|保留默认值(*)****|
   |目标|选择**应用程序安全组**|
   |目标应用程序安全组|选择**asg-mgmt**|
   |服务|选择**RDP**|
   |目标端口范围|保留默认值**3389**|
   |协议|保留默认值 **TCP**|
   |操作|保留默认值**允许**|
   |优先级|保留默认值**110**|
   |名称|输入 *allowrdpall*|
   
6. 选择 **添加** 。

### 在先前创建的虚拟网络中创建两个虚拟机（VM）。

1. 在门户中，搜索并选择**虚拟机**。

2. 在**虚拟机**中，依次选择+ **创建**、**Azure 虚拟机**。
   
3. 在**创建虚拟机**的**基本信息**选项卡中，输入或选择以下信息 ：

   |设置|值|
   |---|---|
   |**项目详细信息**|
   |Susbcription|选择订阅|
   |资源组|选择 **az-rg-1**|
   |**实例详细信息**|
   |虚拟机名称|输入**vm-1**|
   |区域|选择 **(US)美国东部**|
   |可用性选项|从“可用性区域”下拉菜单中，选择“不需要基础结构冗余”****|
   |安全类型|在“安全类型”下拉菜单中，选择“标准”****|
   |Image|从“映像”下拉菜单中，选择“Windows Server 2022 Datacenter:**** Azure 版 - x64 Gen2|
   |VM 架构|保留默认值**x64**|
   |使用 Azure Spot 折扣运行|保留默认值未选中|
   |大小|将默认设置保留为 **Standard_D2s_v3-2 vcpus、8 GiB 内存**|
   |**管理员帐户**|
   |身份验证类型|选择**密码**|
   |用户名|输入 **Tenantadmin1**|
   |密码|输入 **Superuser#150**|
   |确认密码|重新输入 **Superuser#150**|
   |**入站端口规则**|
   |公共入站端口|选择**无**|
 
4. 选择**下一步：磁盘**，然后选择下一步：网络。

5. 在“**网络**”选项卡中，验证或输入以下信息：

   |设置|值|
   |---|---|
   |**网络接口**|
   |虚拟网络|选择**vnet-1**|
   |子网|选择**默认值 (10.0.0.0/24)**|
   |公共 IP|保留默认值新建公共 IP|
   |NIC 网络安全组|选择**无**|
   
6. 选择**查看 + 创建**选项卡，或选择页面底部的**查看 + 创建**按钮 。

7. 选择**创建**。 部署 VM 可能需要几分钟时间。
  
   - 创建第二个虚拟机

   - 重复上述步骤，使用以下设置创建第二个名为**vm-2**的虚拟机。

   - 等待 VM 部署完成，然后转到下一部分。

### 将网络接口关联到应用程序安全组

>**注意**：当你创建 VM 时，Azure 已经为每个 VM 创建了一个网络接口，并已将该接口附加到 VM。 请将每个 VM 的网络接口添加到前面创建的应用程序安全组：

1. 在门户顶部的搜索框中，输入**虚拟机**。 在搜索结果中，选择**虚拟机**。

2. 选择 **vm-1**
 
3. 从“vm-1”部分中选择“网络”********

4. 选择“**应用程序安全组**”选项卡，然后选择“**+ 添加应用程序安全组**”

5. 从**添加应用程序安全组**模板中，选择**应用程序安全组**模板中的“**asg-mgmt**”，然后单击模板页面底部的“**添加**”图标。

![image](https://github.com/MicrosoftLearning/Secure-Azure-with-Microsoft-Defender-Cloud-Compliance-Controls/assets/91347931/dd17aeba-8e16-431b-b921-527367fea484)

6. 对 **vm-2** 重复前面的步骤，在**应用程序安全组**模板中选择“**asg-web**”。

> **结果**：您已创建了一个虚拟网络基础架构，并使用 Azure 门户的网络安全组过滤了网络流量。

> **注意**：请不要删除本实验室中的资源，因为这些资源是下面练习所必需的： 练习 03b - 在虚拟机上启用即时访问，练习 05a - 配置密钥库防火墙和虚拟网络，以及练习 05b - 通过软删除和清除保护配置 Azure 密钥库恢复管理。
