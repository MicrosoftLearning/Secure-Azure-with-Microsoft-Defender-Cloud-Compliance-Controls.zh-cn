---
lab:
  title: 练习 - 部署一个虚拟机，用于在整个专用终结点内以私密且安全的方式测试与 SQL 服务器的连接
  module: Module 06 - Connect to an Azure SQL server using an Azure Private Endpoint using the Azure portal
---


>**注意**：为了完成此实验室，你将需要一个 [Azure 订阅](https://azure.microsoft.com/en-us/free/?azure-portal=true)。 其中您拥有管理权限。 


Azure 专用终结点是 Azure 中专用链接的构建基块。 它使 Azure 资源（例如虚拟机 (VM)）能够以私密且安全的方式来与 Azure SQL 服务器等专用链接资源通信。

---

## 技能任务

- 创建虚拟网络和堡垒主机。
  
- 创建虚拟机。
  
- 创建 Azure SQL 服务器和专用终结点。
  
- 测试到 SQL 服务器专用终结点的连接。

## 练习说明 

### 创建资源组和虚拟网络。

>堡垒主机将用于安全地连接到虚拟机，以测试专用终结点。

1. 启动浏览器会话并登录到 [Azure 门户](https://portal.azure.com/)。
   
2. 从 Azure 门户菜单中选择 + **创建资源** > **网络**** > 虚拟网络**，或在门户搜索框中搜索虚拟网络。

3. 选择**创建**。

4. 在**创建虚拟网络**的**基本信息**选项卡中，输入或选择以下信息：
   
   |设置|值|
   |---|---|
   |**项目详细信息**|
   |订阅|选择订阅。|
   |资源组|选择**新建**。 输入 **CreateSQLEndpointTutorial。** 选择**确定**|
   |**实例详细信息**|
   |虚拟网络名称|输入 **myVNet1a。**|
   |区域|选择**美国东部**。|  
    
5. 选择**IP 地址**选项卡，或选择页面底部的**下一步：IP 地址**按钮。

6. 在**IP 地址**选项卡上，输入以下信息：

   |设置|值|
   |---|---|
   |IPv4 地址空间|输入 **10.1.0.0/16**。|

7. 在**子网名称**下，选择词语**默认**。

8. 在**编辑子网**中输入以下信息：

   |设置|值|
   |---|---|
   |子网名称|输入 **mySubnet1a。**|
   |子网地址范围|输入 **10.1.0.0/24**。|

9. 选择**保存**。

10. 选择**安全**选项卡。

11. 在**堡垒主机**下，选择**启用**。 输入此信息：
    
    |设置|值|
    |---|---|
    |Bastion 名称|输入**myBastionHost**。|
    |AzureBstionSubnet 地址空间|输入 **10.1.1.0/24**。|
    |公共 IP 地址|选择**新建**。 在**名称**中，输入 **My BastionIP**。 选择确定****。| 
 
### 创建虚拟机。

>**注意：** 在此任务中，您将创建一个用于测试专用终结点的虚拟机。

1. 在 Azure 门户菜单中，选择**创建资源** > **计算** > **虚拟机**，或者在门户搜索框中搜索**虚拟机**。
   
2. 在**创建虚拟机**中，在**基本信息**选项卡中输入或选择值 ：

   |设置|值|
   |---|---|
   |**项目详细信息**|
   |用户名|选择订阅|
   |资源组|选择**CreateSQLEndpointTutorial**。|
   |**实例详细信息**|
   |虚拟机名称|输入**myVM**。|
   |区域|选择 **(US)美国东部**。|
   |可用性选项|保留默认值**不需要基础结构冗余**。|
   |安全类型|保留默认值**标准**。|
   |映像|选择**Windows Server 2022 Datacenter - x64 Gen2**。|
   |VM 架构|选择**x64**。|
   |使用 Azure Spot 折扣运行|保留默认值未选中|
   |大小|保持默认的 **Standard_D2s_v3-2 vcpus、8 GiB 内存。**|
   |**管理员帐户**|
   |身份验证类型|选择**密码**。|
   |用户名|输入 **Tenantadmin2。**|
   |密码|输入 **Superuser#170。**|
   |确认密码|重新输入 **Superuser#170。**|
   |**入站端口规则**|
   |选择入站端口|选择**无**。|

4. 选择**网络**选项卡，或选择**下一步：磁盘**，然后选择**下一步：网络**。
  
5. 在**网络**选项卡中，输入或选择以下信息：

   |设置|值|
   |---|---|
   |**网络接口**|
   |虚拟网络|选择 **myVNet1a。**|
   |子网|选择 **mySubnet1a。**|
   |公共 IP|选择**无**。|
   |NIC 网络安全组|选择**基本**。|
   |公共入站端口|选择**无**。|
  
6. 选择**查看 + 创建**。

7. 检查设置，然后选择**创建**。

### 创建 Azure SQL 服务器和专用终结点

>**注意：** 在此任务中，您将在 Azure 中创建一个 SQL 服务器。

1. 从 Azure 门户菜单中选择 + **创建资源** > **数据库** > **SQL 数据库。**
   
2. 在**创建 SQL 数据库**的**基本信息**选项卡中，输入或选择以下信息：

   |设置|值|
   |---|---|
   |**项目详细信息**|
   |订阅|选择订阅。|
   |资源组|选择**CreateSQLEndpointTutorial**。|
   |**数据库详细信息**|
   |数据库名称|输入 **mysqldatabase**。|
   |服务器|选择**新建**。|  

3. 在**创建 SQL 数据库服务器**中，输入或选择以下信息：
  
   |设置|值|
   |---|---|
   |**服务器详细信息**|
   |服务器名称|输入 **mysqlserver1a。** 如果此名称已被使用，请创建唯一的名称。|
   |位置|选择 **(US)美国东部**。|
   |**身份验证**|
   |身份验证方法|选择**使用 SQL 身份验证**。|
   |服务器管理员登录名|输入 **Tenantadmin2。**|
   |密码|输入**Superuser#170.**|
   |确认密码|输入**Superuser#170.**|

4. 选择确定****。
   
   |设置|值|
   |---|---|
   |**数据库详细信息**|
   |想要使用 SQL 弹性池|请选择**否**。|
   |计算 + 存储|采取默认设置，或选择**配置数据库**以配置计算和存储设置。|
   |**备份存储冗余**|
   |备份存储冗余|选择**本地冗余备份存储**。|
   
5. 选择**网络**选项卡，或选择**下一步：网络**按钮。

6. 在**网络**选项卡中，输入或选择以下信息：

   |设置|值|
   |---|---|
   |**网络连接**|
   |连接方法|选择**专用终结点**。|

7. 在**专用终结点**中选择+ **添加专用终结点** 。

8. 在**创建专用终结点**中，输入或选择以下信息：

   |设置|值|
   |---|---|
   |订阅|选择订阅。|
   |资源组|选择**CreateSQLEndpointTutorial**。|
   |位置|选择**美国东部**。|
   |名称|输入 **myPrivateSQLendpoint**。|
   |目标子资源|选择 **mysqlserver1a。**|
   |**联网**|
   |虚拟网络|选择 **myVNet1a。**|
   |子网|选择 **mySubnet1a。**|
   |**专用 DNS 集成**|
   |与私有 DNS 区域集成|保留默认值**是**。|
   |专用 DNS 区域|保留默认值 **(新建) privatelink.database.windows.net**。|

 9. 选择确定****。

 10. 选择**查看 + 创建**。

 11. 选择**创建**。

### 禁用对 Azure SQL 逻辑服务器的公共访问

>**注意**：在此任务中，假设要禁止对 Azure SQL 服务器的所有公共访问，只允许从虚拟网络进行连接。

1. 在 Azure 门户搜索框中，输入 **mysqlserver** 或前面步骤中输入的服务器名称。

2. 在**网络**页上，选择**公共访问**选项卡，然后在**公用网络访问**中选择**禁用**。

   ![image](https://github.com/MicrosoftLearning/Secure-Azure-services-and-workloads-with-Microsoft-Cloud-Security-Benchmark/assets/91347931/44ff5c24-70cf-49ed-b2ab-5e210c478b3a)


4. 选择**保存**。

### 测试到专用终结点的连接

>**注意**：在此任务中，您将使用在前面步骤中创建的虚拟机通过专用终结点连接到 SQL 服务器。

1. 在左侧导航窗格中选择**资源组**。

2. 选择**CreateSQLEndpointTutorial**。

3. 选择**myVM**。

4. 在 **myVM** 的概述页上，选择连接，然后选择**堡垒**。

5. 输入创建虚拟机时输入的用户名 **Tenantadmin2** 和密码 **Superuser#170**。

   **重要信息：** 在选择连接之前，请转到边缘设置/弹出窗口和重定向/并将阻止开关切换为关闭****。

7. 选择**连接**按钮。
  
8. 连接后，在服务器上打开 Windows PowerShell。

9. 用在前面步骤中创建的 SQL 服务器名称`nslookup sqlserver-name.database.windows.net.`替换 **sqlserver-name**。 你将收到类似于以下所示内容的消息：

   ````  
   Server:  UnKnown
   Address:  168.63.129.16
   
   Non-authoritative answer:
   Name:    mysqlserver1a.privatelink.database.windows.net
   Address:  10.1.0.5
   Aliases:  mysqlserver1a.database.windows.net
   ````
    
>**注意**：SQL 服务器名称将返回 10.1.0.5 的私有 IP 地址。 该地址位于之前创建的 **myVNet1a** 虚拟网络的 **myVNet1a** 子网中。

9. 在 **myVM** 上安装 [SQL Server Management Studio](https://learn.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?preserve-view=true&view=sql-server-2017)。
 
10. 打开 **SQL Server Management Studio**。

11. 在连接服务器中，输入或选择以下信息****：

    |设置|值|
    |---|---|
    |服务器类型|选择**数据库引擎**。|
    |服务器名称|输入 **sqlserver1a.database.windows.net。**|
    |身份验证|选择**SQL Server 身份验证**。|
    |用户名|输入 **Tenantadmin2**。|
    |密码|输入 **Superuser#170**。|
    |记住密码|选择**是**。|
   
12. 选择**连接** 。

13. 浏览左侧菜单中的数据库。

14. （可选）创建或查询 mydatabase 中的信息。

15. 关闭与 myVM 的远程桌面连接。
  
> **结果：** 您已通过 Azure 门户使用 Azure 专用终结点连接到 Azure SQL 服务器。
