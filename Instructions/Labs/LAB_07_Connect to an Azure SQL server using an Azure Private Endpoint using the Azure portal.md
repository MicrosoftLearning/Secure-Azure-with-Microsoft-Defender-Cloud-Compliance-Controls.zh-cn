---
lab:
  title: 练习 07 - 通过 Azure 门户使用 Azure 专用终结点连接到 Azure SQL 服务器
  module: Module 08 - Connect to an Azure SQL server using an Azure Private Endpoint using the Azure portal
---


>**注意**：为了完成此实验室，你将需要一个 [Azure 订阅](https://azure.microsoft.com/en-us/free/?azure-portal=true)。 其中您拥有管理权限。 


Azure 专用终结点是 Azure 中专用链接的构建基块。 它使 Azure 资源（例如虚拟机 (VM)）能够以私密且安全的方式来与 Azure SQL 服务器等专用链接资源通信。

---

## 技能任务

- 创建虚拟网络和堡垒主机。
  
- 创建虚拟机。
  
- 创建 Azure SQL 服务器和专用终结点。
  
- 测试到 SQL 服务器专用终结点的连接。

## 练习说明 

### 创建资源组和虚拟网络。

>**注意**：堡垒主机将用于安全地连接到虚拟机，以测试专用终结点。 

1. 启动浏览器会话并登录到 [Azure 门户](https://portal.azure.com/)。
   
2. 在门户顶部的搜索框中输入**虚拟网络**。 在搜索结果中，选择**虚拟网络**。

3. 在“**虚拟网络**”页面上，选择“**+ 创建**”。

4. 在**创建虚拟网络**的**基本信息**选项卡中，输入或选择以下信息：
   
   |设置|值|
   |---|---|
   |**项目详细信息**|
   |订阅|选择订阅。|
   |资源组|选择 **az-rg-1。**|
   |**实例详细信息**|
   |虚拟网络名称|输入 **vnet-2。**|
   |区域|选择 **(US)美国东部**。|  
    
5. 选择**下一步**，转到**安全性**选项卡。
  
6. 在“安全性”选项卡的 Azure Bastion 部分中选择“**启用 Azure Bastion**”。

   >**备注**：Azure Bastion 是一项付费服务，可通过 TLS 为虚拟机提供安全的 RDP/SSH 连接。 在你通过 Azure Bastion 连接时，你的虚拟机无需公共 IP 地址。 

7. 在 **Azure Bastion** 字段中输入或选择以下信息：

   |设置|值|
   |---|---|
   |**项目详细信息**|
   |Azure Bastion 主机 |输入 **az-bastionhost-1a。**|
   |Azure Bastion 公共 IP 地址名称|选择“**创建公共 IP 地址**”|
   |添加公共 IP 地址|选择**确定**|

9. 选择“下一步”，转到“IP 地址”选项卡。

10. 在**子网**列下现有配置的“**IPv4 地址空间**”框中，单击**默认**条目。

11. 在“**编辑子网**”模板中，输入或选择以下信息：

    |设置|值|
    |---|---|
    |**项目详细信息**|
    |子网用途|将默认设置保留为“默认”。|
    |名称|**subnet-2**|
    |IPv4 地址范围|将默认设置保留为 10.0.0.0/16。|
    |开始地址|将默认设置保留为 /24（256 个地址）。|

13. 在“**编辑子网**”页底部，选择“**保存**”。

14. 在“**IP 地址**”页底部，选择“**查看 + 创建**”。

    >**注意**：Bastion 部署需要最多 15 分钟来完成实例化。

15. 在“**查看 + 创建**”页面底部，选择“**创建**”。
 
### 创建虚拟机。

>**注意：** 在此任务中，您将创建一个用于测试专用终结点的虚拟机。

1. 在门户中，搜索并选择**虚拟机**。

2. 在**虚拟机**中，依次选择+ **创建**、**Azure 虚拟机**。

3. 在“创建虚拟机”的“**基本信息**”页中，输入或选择以下信息：

   |设置|值|
   |---|---|
   |**项目详细信息**|
   |Susbcription|选择订阅。|
   |资源组|选择 **az-rg-1。**|
   |**实例详细信息**|
   |虚拟机名称|输入**vm-3。**|
   |区域|选择 **(US)美国东部**。|
   |可用性选项|从“可用性区域”下拉菜单中，选择“**不需要基础结构冗余**”。|
   |安全类型|在“安全类型”下拉菜单中，选择“**标准**”。|
   |映像|选择**Windows Server 2022 Datacenter - x64 Gen2**。|
   |VM 架构|选择**x64**。|
   |使用 Azure Spot 折扣运行|将默认设置保留为“未选中”。|
   |大小|将默认设置保留为 Standard_D2s_v3-2 vcpus、8 GiB 内存。|
   |**管理员帐户**|
   |用户名|输入 **Tenantadmin2。**|
   |密码|输入 **Superuser#170。**|
   |确认密码|重新输入 **Superuser#170。**|
   |**入站端口规则**|
   |选择入站端口|选择**无**。|

5. 选择“下一步: 磁盘”，然后选择“下一步: 网络”。
  
6. 在“**网络**”页中，输入或选择以下信息：

   |设置|值|
   |---|---|
   |**网络接口**|
   |虚拟网络|选择“**vnet-2**”。|
   |子网|选择 **subnet-2 (10.0.0.0/24)。**|
   |公共 IP|选择**无**。|
   |NIC 网络安全组|选择**基本**。|
   |公共入站端口|选择**无**。|
   |选择入站端口|将默认设置保留为“空白”。|
   |删除 VM 时删除 NIC|将默认设置保留为“选中启用加速网络”。|
   |负载均衡|将默认设置保留为“无”。|
  
6. 选择“查看 + 创建”。

7. 检查设置，然后选择**创建**。

### 创建 Azure SQL 服务器和专用终结点

>**注意：** 在此任务中，您将在 Azure 中创建一个 SQL 服务器。

1. 在门户顶部的搜索框中，输入 **SQL 数据库。** 在搜索结果中选择“SQL 数据库”。

2. 在“**SQL 数据库**”页上，选择“**+ 创建**”。
   
3. 在**创建 SQL 数据库**的**基本信息**选项卡中，输入或选择以下信息：

   |设置|值|
   |---|---|
   |**项目详细信息**|
   |订阅|选择订阅。|
   |资源组|选择 **az-rg-1。**|
   |**数据库详细信息**|
   |数据库名称|输入 **az-sql-db1a。**|
   |服务器名称|输入 **az-sql-svr1a。** 如果此名称已被使用，请创建唯一的名称。|
   |位置|选择 **(US)美国东部**。|
   |**身份验证**|
   |身份验证方法|选择**使用 SQL 身份验证**。|
   |服务器管理员登录名|输入 **Tenantadmin2。**|
   |密码|输入**Superuser#170.**|
   |确认密码|输入**Superuser#170.**|

4. 选择确定****。
   
   |设置|值|
   |---|---|
   |**数据库详细信息**|
   |想要使用 SQL 弹性池|将默认设置保留为“否”。|
   |工作负载环境|将默认设置保留为“开发”。|
   |计算 + 存储|将默认设置保留为“常规用途 - 无服务器”。|
   |**备份存储冗余**|
   |备份存储冗余|选择**本地冗余备份存储**。|
   
5. 选择**网络**选项卡，或选择**下一步：网络**按钮。

6. 在**网络**选项卡中，输入或选择以下信息：

   |设置|值|
   |---|---|
   |**网络连接**|
   |连接方法|选择**专用终结点**。|
   |连接策略|将默认设置保留为“默认” - 对源自 Azure 内部的所有客户端连接使用“重定向策略”（专用终结点除外），并对源自 Azure 外部的所有客户端连接使用“代理”|
   |加密连接|将默认设置保留为“TLS.12”|

7. 在**专用终结点**中选择+ **添加专用终结点** 。

8. 在**创建专用终结点**中，输入或选择以下信息：

   |设置|值|
   |---|---|
   |订阅|选择订阅。|
   |资源组|选择 **az-rg-1。**|
   |位置|选择**美国东部**。|
   |名称|输入 **az-pe-1a。**|
   |目标子资源|将默认设置保留为 SqlServer。|
   |**联网**|
   |虚拟网络|选择“**vnet-2**”。|
   |子网|选择 **subnet-2。**|
   |**专用 DNS 集成**|
   |与私有 DNS 区域集成|将默认设置保留为“是”。|
   |专用 DNS 区域|将默认设置保留为（新建）privatelink.database.windows.net。|

9. 选择“确定”****。

10. 选择**查看 + 创建**。

11. 选择**创建**。

### 禁用对 Azure SQL 逻辑服务器的公共访问

>**注意**：在此任务中，假设要禁止对 Azure SQL 服务器的所有公共访问，只允许从虚拟网络进行连接。 **公共访问**设置可能默认为**禁用。**

1. 在 Azure 门户搜索框中，输入 **az-sql-svr1a** 或前面步骤中输入的服务器名称。

2. 从 **az-sql-svr1a** 的“**安全**”部分中选择“**网络**”。 在**网络**页上，选择**公共访问**选项卡，然后在**公用网络访问**中选择**禁用**。

   ![image](https://github.com/MicrosoftLearning/Secure-Azure-services-and-workloads-with-Microsoft-Cloud-Security-Benchmark/assets/91347931/44ff5c24-70cf-49ed-b2ab-5e210c478b3a)

3. 选择**保存**。

### 测试到专用终结点的连接

>**注意**：在此任务中，您将使用在前面步骤中创建的虚拟机通过专用终结点连接到 SQL 服务器。

1. 在左侧导航窗格中选择**资源组**。

2. 选择 **az-rg-1。**

3. 选择 **vm-3。**

4. 在 **vm-3** 的概述页面上，选择“连接”，然后选择“**Bastion**”。

5. 输入创建虚拟机时输入的用户名 **Tenantadmin2** 和密码 **Superuser#170**。

   **重要信息：** 在选择连接之前，请转到边缘设置/弹出窗口和重定向/并将阻止开关切换为关闭****。

7. 选择**连接**按钮。
  
8. 连接后，在服务器上打开 Windows PowerShell。

9. 用在前面步骤中创建的 SQL 服务器名称`nslookup sqlserver-name.database.windows.net.`替换 **sqlserver-name**。 你将收到类似于以下所示内容的消息：

   ````  
   Server:  UnKnown
   Address:  168.63.129.16
   
   Non-authoritative answer:
   Name:    az-sql-svr1a.privatelink.database.windows.net
   Address:  10.1.0.5
   Aliases:  az-sql-svr1a.database.windows.net
   ````
    
>**注意**：SQL 服务器名称将返回 10.1.0.5 的私有 IP 地址。 此地址位于之前创建的 **vnet-2** 虚拟网络的 **az-sql-svr1a** 子网中。

9. 在 **vm-3** 上安装 [SQL Server Management Studio](https://learn.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?preserve-view=true&view=sql-server-2017)。
 
10. 打开 **SQL Server Management Studio**。

11. 在连接服务器中，输入或选择以下信息****：

    |设置|值|
    |---|---|
    |服务器类型|选择**数据库引擎**。|
    |服务器名称|输入 **az-sql-svr1a.database.windows.net。**|
    |身份验证|选择**SQL Server 身份验证**。|
    |用户名|输入 **Tenantadmin2**。|
    |密码|输入 **Superuser#170**。|
    |记住密码|选择**是**。|
    |连接安全性|
    |加密|将默认设置保留为“强制”。|
   
13. 选择**连接** 。

14. 浏览左侧菜单中的数据库。

15. 关闭与 Vm-3 的远程桌面连接。
  
> **结果：** 您已通过 Azure 门户使用 Azure 专用终结点连接到 Azure SQL 服务器。
